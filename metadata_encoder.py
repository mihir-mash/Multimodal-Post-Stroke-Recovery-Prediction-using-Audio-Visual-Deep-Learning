# -*- coding: utf-8 -*-
"""Metadata_encoder.ipynb

Automatically generated by Colab.

Original file is located at
"""

import pandas as pd

clinical_path = "path_to_clinical_data.csv"
clinical_df = pd.read_csv(clinical_path)

clinical_df = clinical_df.rename(columns={"SubjectID": "Subject ID"})

# Keep required columns
clinical_df = clinical_df[[
    "Subject ID",
    "AgeSession",
    "Gender",
    "Type",
    "MnthsfromStroke",
    "Facial asymmetry"
]]

clinical_df.head()

gender_to_idx = {"M": 0, "F": 1}

type_to_idx = {
    t: i for i, t in enumerate(clinical_df["Type"].unique())
}

asym_to_idx = {
    a: i for i, a in enumerate(clinical_df["Facial asymmetry"].unique())
}

print("Gender mapping:", gender_to_idx)
print("Stroke type mapping:", type_to_idx)
print("Asymmetry mapping:", asym_to_idx)

# Convert to numeric safely
clinical_df["AgeSession"] = pd.to_numeric(clinical_df["AgeSession"], errors="coerce")
clinical_df["MnthsfromStroke"] = pd.to_numeric(clinical_df["MnthsfromStroke"], errors="coerce")

# Fill missing values with median (safer than mean for small dataset)
clinical_df["AgeSession"] = clinical_df["AgeSession"].fillna(clinical_df["AgeSession"].median())
clinical_df["MnthsfromStroke"] = clinical_df["MnthsfromStroke"].fillna(clinical_df["MnthsfromStroke"].median())

# Now compute normalization stats
age_mean = clinical_df["AgeSession"].mean()
age_std = clinical_df["AgeSession"].std()

month_mean = clinical_df["MnthsfromStroke"].mean()
month_std = clinical_df["MnthsfromStroke"].std()

print("Age mean/std:", age_mean, age_std)
print("Months mean/std:", month_mean, month_std)

metadata_dict = {}

for _, row in clinical_df.iterrows():
    subject = row["Subject ID"]

    age = row["AgeSession"]
    months = row["MnthsfromStroke"]
    gender = gender_to_idx[row["Gender"]]
    stroke_type = type_to_idx[row["Type"]]
    asym = asym_to_idx[row["Facial asymmetry"]]

    metadata_dict[subject] = {
        "age": age,
        "months": months,
        "gender": gender,
        "type": stroke_type,
        "asym": asym
    }

print("Example metadata entry:")
print(list(metadata_dict.items())[0])

import torch.nn as nn

class MetadataEncoder(nn.Module):
    def __init__(self, num_gender, num_type, num_asym):
        super().__init__()

        self.gender_emb = nn.Embedding(num_gender, 4)
        self.type_emb = nn.Embedding(num_type, 4)
        self.asym_emb = nn.Embedding(num_asym, 4)

        self.cont_proj = nn.Linear(2, 8)

        self.fusion = nn.Sequential(
            nn.Linear(4 + 4 + 4 + 8, 16),
            nn.ReLU(),
            nn.LayerNorm(16)
        )

    def forward(self, age, months, gender, stroke_type, asym):

        gender_e = self.gender_emb(gender)
        type_e = self.type_emb(stroke_type)
        asym_e = self.asym_emb(asym)

        cont = torch.stack([age, months], dim=1)
        cont_e = self.cont_proj(cont)

        x = torch.cat([gender_e, type_e, asym_e, cont_e], dim=1)

        return self.fusion(x)

def get_metadata_tensor(subject):
    meta = metadata_dict[subject]

    age = (meta["age"] - age_mean) / age_std
    months = (meta["months"] - month_mean) / month_std

    return {
        "age": torch.tensor(age, dtype=torch.float32),
        "months": torch.tensor(months, dtype=torch.float32),
        "gender": torch.tensor(meta["gender"], dtype=torch.long),
        "type": torch.tensor(meta["type"], dtype=torch.long),
        "asym": torch.tensor(meta["asym"], dtype=torch.long)
    }

import torch

# Example usage of get_metadata_tensor
# Assuming 'S001' is a valid subject ID from metadata_dict
subject = "S001"
meta_tensors = get_metadata_tensor(subject)

print("Metadata tensors for subject 'S001':")
for key, value in meta_tensors.items():
    print(f"{key}: {value}")

import torch

subjects = []
age_list = []
months_list = []
gender_list = []
type_list = []
asym_list = []

for subject, meta in metadata_dict.items():
    subjects.append(subject)
    age_list.append(meta["age"])
    months_list.append(meta["months"])
    gender_list.append(meta["gender"])
    type_list.append(meta["type"])
    asym_list.append(meta["asym"])

metadata_pt = {
    "subjects": subjects,
    "age": torch.tensor(age_list, dtype=torch.float32),
    "months": torch.tensor(months_list, dtype=torch.float32),
    "gender": torch.tensor(gender_list, dtype=torch.long),
    "type": torch.tensor(type_list, dtype=torch.long),
    "asym": torch.tensor(asym_list, dtype=torch.long),
    "age_mean": age_mean,
    "age_std": age_std,
    "month_mean": month_mean,
    "month_std": month_std
}

save_path = "path_to_save_metadata.pt"
torch.save(metadata_pt, save_path)

print("Metadata saved at:", save_path)

